<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Productivity Hub</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --timer-bg: #ffffff;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 50px;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding-top: 2rem;
        }

        /* Timer Card Styling */
        .timer-card {
            background: var(--timer-bg);
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .timer-display {
            font-size: 6rem;
            font-weight: 700;
            color: #2c3e50;
            font-variant-numeric: tabular-nums; /* Keeps numbers width consistent */
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .mode-badge {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
        }

        .bg-focus { background-color: #e74a3b; color: white; }
        .bg-break { background-color: #1cc88a; color: white; }

        /* Progress Bar */
        .progress {
            height: 10px;
            border-radius: 0;
            background-color: #eaecf4;
        }
        .progress-bar {
            transition: width 1s linear; /* Smooth transition for seconds */
        }

        /* Controls */
        .btn-control {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        /* History Section */
        .history-card {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            background: white;
        }
        
        .task-item {
            transition: background-color 0.2s;
            border-left: 4px solid transparent;
        }
        .task-item.completed-focus { border-left-color: #e74a3b; }
        .task-item.completed-break { border-left-color: #1cc88a; }
        
        .timestamp {
            font-size: 0.8rem;
            color: #858796;
        }

        /* Settings toggle */
        .settings-panel {
            display: none;
            background: #f8f9fc;
            padding: 1rem;
            border-top: 1px solid #e3e6f0;
        }
        .settings-panel.active {
            display: block;
        }
    </style>
</head>
<body>

<div class="app-container px-3">
    
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="fw-bold text-dark"><i class="fas fa-stopwatch me-2"></i>ProFlow Timer</h1>
        <p class="text-muted">Focus, Track, Repeat.</p>
    </div>

    <!-- Main Timer Card -->
    <div class="card timer-card mb-4">
        <!-- Progress Bar -->
        <div class="progress">
            <div class="progress-bar bg-focus" id="progressBar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <div class="card-body text-center p-5">
            
            <!-- Mode Indicator -->
            <div class="mb-4">
                <span id="modeBadge" class="mode-badge bg-focus">Focus Mode</span>
            </div>

            <!-- Timer Display -->
            <div class="timer-display mb-4" id="timeDisplay">25:00</div>

            <!-- Active Task Display -->
            <div class="mb-4" style="min-height: 30px;">
                <h5 class="text-muted fw-normal" id="currentTaskDisplay">
                    <i class="fas fa-thumbtack me-1 small"></i> 
                    <span id="taskText">No active task</span>
                </h5>
            </div>

            <!-- Controls -->
            <div class="d-flex justify-content-center gap-3 mb-3">
                <button class="btn btn-primary btn-control" id="startBtn" title="Start">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-warning btn-control" id="pauseBtn" title="Pause" style="display: none;">
                    <i class="fas fa-pause text-white"></i>
                </button>
                <button class="btn btn-secondary btn-control" id="resetBtn" title="Reset">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="btn btn-info btn-control text-white" id="settingsBtn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Settings Panel (Hidden by default) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="row g-3">
                <div class="col-6">
                    <label class="form-label small fw-bold">Focus Duration (min)</label>
                    <input type="number" class="form-control" id="focusDurationInput" value="25" min="1" max="60">
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold">Break Duration (min)</label>
                    <input type="number" class="form-control" id="breakDurationInput" value="5" min="1" max="30">
                </div>
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoBreakCheck">
                        <label class="form-check-label small" for="autoBreakCheck">Auto-start Break when Focus ends</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="notificationCheck" checked>
                        <label class="form-check-label small" for="notificationCheck">Enable Browser Notifications</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Input Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="input-group input-group-lg shadow-sm">
                <span class="input-group-text bg-white border-0"><i class="fas fa-pen"></i></span>
                <input type="text" class="form-control border-0" id="taskInput" placeholder="What are you working on?">
                <button class="btn btn-primary px-4" id="setTaskBtn">Set Task</button>
            </div>
        </div>
    </div>

    <!-- Productivity History -->
    <div class="card history-card">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-secondary"><i class="fas fa-history me-2"></i>Session Log</h5>
            <button class="btn btn-sm btn-outline-danger" id="clearHistoryBtn">Clear</button>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="historyList">
                <!-- History items injected here -->
                <div class="text-center p-4 text-muted">No sessions completed yet.</div>
            </div>
        </div>
    </div>

</div>

<!-- Notification Audio (Simple Bell Sound) -->
<audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
    /**
     * Advanced Pomodoro Productivity Hub
     * Core Technologies: JavaScript (setInterval, Audio, Notification), localStorage
     */

    // --- CONFIGURATION & STATE ---
    const state = {
        timeLeft: 1500,      // 25 minutes in seconds
        totalTime: 1500,     // Used for progress bar calculation
        mode: 'focus',       // 'focus' or 'break'
        isRunning: false,
        timerId: null,
        startTime: null,     // For drift correction
        secondsRemainingAtStart: null, // For drift correction
        currentTask: "General Focus",
        settings: {
            focusTime: 25,
            breakTime: 5,
            autoBreak: false,
            notifications: true
        }
    };

    // --- DOM ELEMENTS ---
    const els = {
        display: document.getElementById('timeDisplay'),
        progressBar: document.getElementById('progressBar'),
        modeBadge: document.getElementById('modeBadge'),
        startBtn: document.getElementById('startBtn'),
        pauseBtn: document.getElementById('pauseBtn'),
        resetBtn: document.getElementById('resetBtn'),
        settingsBtn: document.getElementById('settingsBtn'),
        settingsPanel: document.getElementById('settingsPanel'),
        taskInput: document.getElementById('taskInput'),
        setTaskBtn: document.getElementById('setTaskBtn'),
        taskDisplay: document.getElementById('taskText'),
        historyList: document.getElementById('historyList'),
        clearHistoryBtn: document.getElementById('clearHistoryBtn'),
        // Inputs
        focusInput: document.getElementById('focusDurationInput'),
        breakInput: document.getElementById('breakDurationInput'),
        autoBreakCheck: document.getElementById('autoBreakCheck'),
        notifCheck: document.getElementById('notificationCheck'),
        audio: document.getElementById('alarmSound')
    };

    // --- INITIALIZATION ---
    function init() {
        loadHistory();
        requestNotificationPermission();
        updateDisplay();
    }

    // --- TIMER LOGIC (THE CORE) ---

    function startTimer() {
        if (state.isRunning) return; // Prevent multiple intervals (Safety Check)

        state.isRunning = true;
        state.startTime = Date.now();
        state.secondsRemainingAtStart = state.timeLeft;

        toggleControls(true);

        // DRIFT CORRECTION LOGIC:
        // Instead of just timeLeft--, we calculate the difference between now and start.
        state.timerId = setInterval(() => {
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - state.startTime) / 1000);
            
            // Calculate exact time remaining
            const newTimeLeft = state.secondsRemainingAtStart - elapsedSeconds;

            if (newTimeLeft !== state.timeLeft) {
                state.timeLeft = newTimeLeft;
                updateDisplay();
                updateTitle();
            }

            if (state.timeLeft <= 0) {
                completeTimer();
            }
        }, 100); // Check every 100ms for responsiveness, though calculation handles seconds
    }

    function pauseTimer() {
        if (!state.isRunning) return;
        clearInterval(state.timerId);
        state.isRunning = false;
        state.timerId = null;
        toggleControls(false);
        document.title = "Paused - ProFlow";
    }

    function resetTimer() {
        pauseTimer();
        // Reset to whatever the current mode's duration is configured to
        const duration = state.mode === 'focus' ? state.settings.focusTime : state.settings.breakTime;
        state.timeLeft = duration * 60;
        state.totalTime = state.timeLeft;
        updateDisplay();
        updateTitle(true); // Reset title
    }

    function completeTimer() {
        pauseTimer(); // Stop the interval
        state.timeLeft = 0;
        updateDisplay();
        
        // Audio & Notification
        playAlarm();
        sendNotification();

        // Logic: Save Session & Switch Mode
        if (state.mode === 'focus') {
            saveSessionToHistory(state.currentTask, state.settings.focusTime);
            switchMode('break');
        } else {
            switchMode('focus');
        }

        // Auto-start check
        if (state.settings.autoBreak && state.mode === 'break') {
            startTimer();
        }
    }

    function switchMode(newMode) {
        state.mode = newMode;
        const duration = newMode === 'focus' ? state.settings.focusTime : state.settings.breakTime;
        
        state.timeLeft = duration * 60;
        state.totalTime = state.timeLeft;

        // UI Updates
        if (newMode === 'focus') {
            els.modeBadge.textContent = "Focus Mode";
            els.modeBadge.className = "mode-badge bg-focus";
            els.progressBar.className = "progress-bar bg-focus";
            document.body.style.setProperty('--primary-color', '#4e73df');
        } else {
            els.modeBadge.textContent = "Break Time";
            els.modeBadge.className = "mode-badge bg-break";
            els.progressBar.className = "progress-bar bg-break";
            document.body.style.setProperty('--primary-color', '#1cc88a');
        }
        
        updateDisplay();
    }

    // --- UI UPDATES ---

    function updateDisplay() {
        const minutes = Math.floor(state.timeLeft / 60);
        const seconds = state.timeLeft % 60;
        const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        els.display.textContent = formattedTime;

        // Update Progress Bar
        const progressPercentage = (state.timeLeft / state.totalTime) * 100;
        els.progressBar.style.width = `${progressPercentage}%`;
    }

    function updateTitle(reset = false) {
        if (reset) {
            document.title = "Pomodoro Productivity Hub";
            return;
        }
        const minutes = Math.floor(state.timeLeft / 60);
        const seconds = state.timeLeft % 60;
        const formatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const modeLabel = state.mode === 'focus' ? 'Focus' : 'Break';
        document.title = `(${formatted}) ${modeLabel}`;
    }

    function toggleControls(running) {
        if (running) {
            els.startBtn.style.display = 'none';
            els.pauseBtn.style.display = 'flex';
            els.settingsBtn.disabled = true; // Lock settings while running
        } else {
            els.startBtn.style.display = 'flex';
            els.pauseBtn.style.display = 'none';
            els.settingsBtn.disabled = false;
        }
    }

    // --- SETTINGS & INPUTS ---

    els.setTaskBtn.addEventListener('click', () => {
        const task = els.taskInput.value.trim();
        if (task) {
            state.currentTask = task;
            els.taskDisplay.textContent = task;
            els.taskInput.value = '';
        }
    });

    els.settingsBtn.addEventListener('click', () => {
        els.settingsPanel.classList.toggle('active');
    });

    // Listen for setting changes
    els.focusInput.addEventListener('change', (e) => {
        state.settings.focusTime = parseInt(e.target.value);
        if (!state.isRunning && state.mode === 'focus') resetTimer();
    });

    els.breakInput.addEventListener('change', (e) => {
        state.settings.breakTime = parseInt(e.target.value);
        if (!state.isRunning && state.mode === 'break') resetTimer();
    });

    els.autoBreakCheck.addEventListener('change', (e) => state.settings.autoBreak = e.target.checked);
    els.notifCheck.addEventListener('change', (e) => state.settings.notifications = e.target.checked);


    // --- BROWSER INTEGRATION (Audio & Notifications) ---

    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    }

    function playAlarm() {
        // Reset audio to start and play
        els.audio.currentTime = 0;
        els.audio.play().catch(e => console.log("Audio play failed (user interaction required first):", e));
    }

    function sendNotification() {
        if (!state.settings.notifications) return;

        if (Notification.permission === "granted") {
            const title = state.mode === 'focus' ? "Focus Session Complete!" : "Break is Over!";
            const body = state.mode === 'focus' ? 
                "Great job! Time to take a break." : 
                "Time to get back to work!";
            
            new Notification(title, {
                body: body,
                icon: "https://cdn-icons-png.flaticon.com/512/1456/1456186.png" // Generic timer icon
            });
        }
    }

    // --- PERSISTENCE (LOCALSTORAGE) ---

    function saveSessionToHistory(task, duration) {
        const session = {
            id: Date.now(),
            task: task,
            duration: duration,
            timestamp: new Date().toLocaleTimeString(),
            date: new Date().toLocaleDateString(),
            type: 'focus'
        };

        let history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
        history.unshift(session); // Add to top
        localStorage.setItem('pomodoroHistory', JSON.stringify(history));
        
        renderHistory();
    }

    function loadHistory() {
        renderHistory();
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
        els.historyList.innerHTML = '';

        if (history.length === 0) {
            els.historyList.innerHTML = '<div class="text-center p-4 text-muted">No sessions completed yet.</div>';
            return;
        }

        history.forEach(item => {
            const div = document.createElement('div');
            div.className = `list-group-item task-item completed-${item.type} d-flex justify-content-between align-items-center`;
            div.innerHTML = `
                <div>
                    <div class="fw-bold">${item.task}</div>
                    <div class="timestamp"><i class="far fa-clock me-1"></i>${item.date} at ${item.timestamp}</div>
                </div>
                <span class="badge bg-light text-dark border">${item.duration} min</span>
            `;
            els.historyList.appendChild(div);
        });
    }

    els.clearHistoryBtn.addEventListener('click', () => {
        if(confirm("Are you sure you want to clear your session log?")) {
            localStorage.removeItem('pomodoroHistory');
            renderHistory();
        }
    });

    // --- CONTROL EVENT LISTENERS ---
    els.startBtn.addEventListener('click', startTimer);
    els.pauseBtn.addEventListener('click', pauseTimer);
    els.resetBtn.addEventListener('click', resetTimer);

    // Initialize App
    init();

</script>

</body>
</html>